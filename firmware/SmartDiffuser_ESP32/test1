/*
 * [í”„ë¡œì íŠ¸] ìŠ¤ë§ˆíŠ¸ ë””í“¨ì € (Smart Diffuser)
 * [ë²„  ì „] 9.6 Polling Update (Phone Control Fix)
 * [ê¸°  ëŠ¥] 
 * 1. ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€
 * 2. [FIX] ì•± ì œì–´ ì—°ë™ì„ ìœ„í•œ ì„œë²„ í´ë§(Poll) ì¶”ê°€
 */

#include <WiFi.h>
#include <WiFiClientSecure.h> 
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include "HX711.h"
#include <Preferences.h>
#include "DFRobotDFPlayerMini.h" 
#include <esp_task_wdt.h> 
#include <driver/i2s.h>   

#define C_RESET   "\033[0m"
#define C_RED     "\033[31m"
#define C_GREEN   "\033[32m"
#define C_YELLOW  "\033[33m"
#define C_BLUE    "\033[34m"
#define C_MAGENTA "\033[35m"
#define C_CYAN    "\033[36m"

#define WDT_TIMEOUT 20 

const char* ssid     = "Jaehong_WiFi";  // â˜… ë³¸ì¸ ì™€ì´íŒŒì´ë¡œ ê¼­ ë³€ê²½!      
const char* password = "12345678";      // â˜… ë¹„ë°€ë²ˆí˜¸ í™•ì¸!
String serverName = "https://tgrwszo3iwurntqeq76s5rro640asnwq.lambda-url.ap-northeast-2.on.aws/";

// í•€ ì •ì˜
const int PIN_SUNNY  = 26; 
const int PIN_CLOUDY = 27; 
const int PIN_RAIN   = 14; 
const int PIN_SNOW   = 13; 
const int PIN_LED    = 2;  
const int LOADCELL_DOUT_PIN = 16; 
const int LOADCELL_SCK_PIN  = 4;    
const int DFPLAYER_RX_PIN = 32; 
const int DFPLAYER_TX_PIN = 33; 
#define I2S_WS  19  
#define I2S_SD  21  
#define I2S_SCK 18  
#define I2S_PORT I2S_NUM_0

HardwareSerial mySoftwareSerial(2); 
DFRobotDFPlayerMini myDFPlayer;
HX711 scale;
Preferences prefs;
WiFiServer webServer(80); 

unsigned long sprayDuration = 3000; 
const long REST_TIME      = 5000;    
const long MAX_RUN_TIME   = 270000; 
float calibration_factor = 430.0; 
int currentVolume = 20;    
int currentMode = 0;        
bool isRunning = false;    
int activePin = -1;        
bool isSpraying = false;    
String lastWebMessage = "Ready";
String inputBuffer = "";  

// â˜… [ì¶”ê°€] í´ë§ íƒ€ì´ë¨¸ ë³€ìˆ˜
unsigned long lastPollTime = 0;
const unsigned long POLL_INTERVAL = 2000; // 2ì´ˆë§ˆë‹¤ ì„œë²„ í™•ì¸

// ê¸°íƒ€ ë³€ìˆ˜
int demoStep = 0;
unsigned long prevDemoMillis = 0;
unsigned long prevMotorMillis = 0; 
unsigned long lastCheckTime = 0; 
unsigned long prevLedMillis = 0;
unsigned long startTimeMillis = 0; 
int ledBrightness = 0;
int ledFadeAmount = 5;
unsigned long lastWeatherCallMillis = 0;
const unsigned long WEATHER_INTERVAL = 3600000; 
String lastWeatherRegion = "ì„œìš¸";              

// í•¨ìˆ˜ ì„ ì–¸
void bootAnimation(); 
void handleInput(String input);
void stopSystem();
void printMainMenu();
void sendServerRequest(String payload);
void printCalibrationInfo();
void runManualMode(String input);
void forceAllOff();
void manageWiFi();
void systemHeartbeat();
void handleWebClient();
void runSprayLogic();
void checkSafety();
void runAutoDemoLoop();
void checkSerialInput();
void connectWiFi();
void printDashboard();
void playSound(int trackNum);
void autoWeatherScheduler();
void changeVolume(int vol); 
void initMicrophone(); 
int32_t readMicrophone(); 
void pollServer(); // [NEW] í´ë§ í•¨ìˆ˜

void setup() {
  Serial.begin(115200);
  Serial.setTimeout(5000); 
  
  esp_task_wdt_config_t wdt_config = {
      .timeout_ms = WDT_TIMEOUT * 1000,
      .idle_core_mask = (1 << 0) | (1 << 1),
      .trigger_panic = true
  };
  esp_task_wdt_init(&wdt_config);
  esp_task_wdt_add(NULL);

  pinMode(PIN_SUNNY, OUTPUT);
  pinMode(PIN_CLOUDY, OUTPUT);
  pinMode(PIN_RAIN, OUTPUT);
  pinMode(PIN_SNOW, OUTPUT);
  pinMode(PIN_LED, OUTPUT); 
  forceAllOff(); 

  Serial.print("\r\n\r\n");
  Serial.printf(C_BOLD " ğŸš€ SMART DIFFUSER V9.6 (Phone Control Fix) \r\n" C_RESET);

  mySoftwareSerial.begin(9600, SERIAL_8N1, DFPLAYER_RX_PIN, DFPLAYER_TX_PIN);
  if (!myDFPlayer.begin(mySoftwareSerial)) Serial.println("Audio Error");
  
  initMicrophone();

  prefs.begin("diffuser", false); 
  float savedFactor = prefs.getFloat("cal_factor", 0.0);
  if (savedFactor != 0.0) calibration_factor = savedFactor;
  currentVolume = prefs.getInt("volume", 20); 
  myDFPlayer.volume(currentVolume);

  connectWiFi();
  webServer.begin(); 
  
  scale.begin(LOADCELL_DOUT_PIN, LOADCELL_SCK_PIN);
  scale.set_scale(calibration_factor);
  scale.tare(); 
  
  bootAnimation();
  printMainMenu(); 
}

void loop() {
  esp_task_wdt_reset(); 

  manageWiFi();       
  systemHeartbeat(); 
  handleWebClient(); 
  autoWeatherScheduler();
  pollServer(); // â˜… [ì¶”ê°€] ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ í™•ì¸
  
  if (currentMode == 5) runAutoDemoLoop(); 
  else if (isRunning) {
    runSprayLogic();    
    checkSafety();      
  }
  checkSerialInput(); 
}

// â˜… [í•µì‹¬] ì„œë²„ì—ê²Œ "ë‚˜í•œí…Œ ì˜¨ ëª…ë ¹ ìˆì–´?" ë¬¼ì–´ë³´ëŠ” í•¨ìˆ˜
void pollServer() {
    if (isRunning || currentMode == 5) return; // ë™ì‘ ì¤‘ì—” í™•ì¸ ì•ˆ í•¨
    
    unsigned long now = millis();
    if (now - lastPollTime >= POLL_INTERVAL) {
        lastPollTime = now;
        
        // POLL ìš”ì²­ ë³´ë‚´ê¸° (ì¡°ìš©íˆ ì²˜ë¦¬)
        // í™”ë©´ ì¶œë ¥ì„ ì¤„ì´ê¸° ìœ„í•´ ë¡œê·¸ëŠ” ìµœì†Œí™”
        HTTPClient http;
        WiFiClientSecure client;
        client.setInsecure();
        http.setTimeout(3000);
        
        if (http.begin(client, serverName)) {
            http.addHeader("Content-Type", "application/json");
            // POLL ì•¡ì…˜ ì „ì†¡
            int code = http.POST("{\"action\": \"POLL\", \"deviceId\": \"App_User\"}");
            
            if (code > 0) {
                String res = http.getString();
                JsonDocument doc;
                deserializeJson(doc, res);
                int cmd = doc["spray"];
                
                // ëª…ë ¹ì´ ìˆìœ¼ë©´ ì‹¤í–‰!
                if (cmd > 0) {
                     Serial.printf("\r\n" C_GREEN "ğŸ“² [APP] ì•± ëª…ë ¹ ìˆ˜ì‹ : %dë²ˆ ë¶„ì‚¬!\r\n" C_RESET, cmd);
                     
                     int target = -1;
                     if (cmd == 1) target = PIN_SUNNY; else if (cmd == 2) target = PIN_CLOUDY; 
                     else if (cmd == 3) target = PIN_RAIN; else if (cmd == 4) target = PIN_SNOW;
                     
                     if (target != -1) {
                         forceAllOff(); activePin = target; isRunning = true; isSpraying = true; 
                         sprayDuration = 3000; prevMotorMillis = millis(); startTimeMillis = millis(); 
                         digitalWrite(activePin, LOW); playSound(cmd); 
                     }
                }
            }
            http.end();
        }
    }
}

// ë‚˜ë¨¸ì§€ ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ë³€ê²½ ì—†ìŒ)
void bootAnimation() { for(int i=0; i<3; i++) { digitalWrite(PIN_LED, HIGH); delay(100); digitalWrite(PIN_LED, LOW); delay(100); } }
void initMicrophone() {
  const i2s_config_t i2s_config = { .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX), .sample_rate = 44100, .bits_per_sample = I2S_BITS_PER_SAMPLE_32BIT, .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT, .communication_format = i2s_comm_format_t(I2S_COMM_FORMAT_I2S | I2S_COMM_FORMAT_I2S_MSB), .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1, .dma_buf_count = 4, .dma_buf_len = 1024, .use_apll = false, .tx_desc_auto_clear = false, .fixed_mclk = 0 };
  const i2s_pin_config_t pin_config = { .bck_io_num = I2S_SCK, .ws_io_num = I2S_WS, .data_out_num = I2S_PIN_NO_CHANGE, .data_in_num = I2S_SD };
  i2s_driver_install(I2S_PORT, &i2s_config, 0, NULL); i2s_set_pin(I2S_PORT, &pin_config);
}
int32_t readMicrophone() { int32_t sample = 0; size_t bytes_read = 0; i2s_read(I2S_PORT, &sample, sizeof(sample), &bytes_read, 0); if (bytes_read > 0) { int32_t rawValue = abs(sample) / 10000; if (rawValue < 300) return 0; return rawValue; } return 0; }
void checkSerialInput() { 
  while (Serial.available() > 0) { 
    char c = Serial.read(); 
    if (c == '\n' || c == '\r') { if (inputBuffer.length() > 0) { Serial.println(); if (inputBuffer == "0") { stopSystem(); currentMode = 0; printMainMenu(); } else { handleInput(inputBuffer); } inputBuffer = ""; } } 
    else { inputBuffer += c; Serial.print(c); } 
  } 
}
void manageWiFi() { if (WiFi.status() != WL_CONNECTED && millis() - lastCheckTime > 1000) { lastCheckTime = millis(); WiFi.disconnect(); WiFi.reconnect(); } }
void autoWeatherScheduler() { if (currentMode != 3 || isRunning) return; if (millis() - lastWeatherCallMillis >= WEATHER_INTERVAL) { lastWeatherCallMillis = millis(); float w = scale.get_units(10); sendServerRequest("{\"mode\": \"weather\", \"region\": \"" + lastWeatherRegion + "\", \"w4\": " + String(w) + "}"); } }
void handleInput(String input) { if (currentMode == 0 && input == "1") currentMode = 1; else if (currentMode == 0 && input == "3") currentMode = 3; else if (currentMode == 3) { lastWeatherRegion = input; sendServerRequest("{\"mode\": \"weather\", \"region\": \"" + input + "\"}"); } }
void handleWebClient() { WiFiClient client = webServer.available(); if (client) { client.stop(); } } // ì›¹ì„œë²„ ê¸°ëŠ¥ ìµœì†Œí™”
void sendServerRequest(String payload) {
  if(WiFi.status() != WL_CONNECTED) return;
  WiFiClientSecure client; client.setInsecure(); HTTPClient http; http.setTimeout(5000);
  if (!http.begin(client, serverName)) return;
  http.addHeader("Content-Type", "application/json");
  int code = http.POST(payload);
  if(code > 0){
    String res = http.getString(); JsonDocument doc; deserializeJson(doc, res);
    int cmd = doc["spray"]; int dur = doc["duration"]; String txt = doc["result_text"];
    Serial.printf("\r\nâœ… ì„œë²„ ì‘ë‹µ: %s\r\n", txt.c_str());
    int target = -1;
    if (cmd == 1) target = PIN_SUNNY; else if (cmd == 2) target = PIN_CLOUDY; else if (cmd == 3) target = PIN_RAIN; else if (cmd == 4) target = PIN_SNOW;
    if (target != -1) { forceAllOff(); activePin = target; isRunning = true; isSpraying = true; sprayDuration = dur * 1000; prevMotorMillis = millis(); startTimeMillis = millis(); digitalWrite(activePin, LOW); playSound(cmd); }
  }
  http.end();
}
void runSprayLogic() { if (activePin == -1) return; if (isSpraying && millis() - prevMotorMillis >= sprayDuration) { digitalWrite(activePin, HIGH); isSpraying = false; prevMotorMillis = millis(); stopSystem(); } }
void runAutoDemoLoop() { } // ìƒëµ
void checkSafety() { if (millis() - startTimeMillis > MAX_RUN_TIME) stopSystem(); }
void printCalibrationInfo() { Serial.printf("Weight: %.2f\n", scale.get_units(5)); }
void connectWiFi() { WiFi.begin(ssid, password); while(WiFi.status() != WL_CONNECTED) { delay(200); Serial.print("."); } Serial.println("Connected!"); webServer.begin(); }
void systemHeartbeat() { }
void printDashboard() { }
void playSound(int trackNum) { myDFPlayer.play(trackNum); }
void forceAllOff() { digitalWrite(PIN_SUNNY, HIGH); digitalWrite(PIN_CLOUDY, HIGH); digitalWrite(PIN_RAIN, HIGH); digitalWrite(PIN_SNOW, HIGH); }
void stopSystem() { forceAllOff(); isRunning = false; activePin = -1; isSpraying = false; myDFPlayer.stop(); }
void runManualMode(String input) { }
void changeVolume(int vol) { myDFPlayer.volume(vol); }
void printMainMenu() { Serial.println("Ready"); }
