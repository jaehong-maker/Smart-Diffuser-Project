/*
 * [í”„ë¡œì íŠ¸] ìŠ¤ë§ˆíŠ¸ ë””í“¨ì € (Smart Diffuser)
 * [ë²„  ì „] 10.1 Expanded Version (Full Features + App Sync)
 * [ì‘ì„±ì] 21í•™ë²ˆ ë¥˜ì¬í™
 * [ê¸°  ëŠ¥] 
 * 1. ì•± ì—°ë™: í´ë§(Polling)ìœ¼ë¡œ ì•± ëª…ë ¹ ì‹¤ì‹œê°„ ìˆ˜ì‹ 
 * 2. ìŒì„± ì¸ì‹: ë§ˆì´í¬ ë…¹ìŒ -> AWS ì „ì†¡ -> ì œì–´
 * 3. í•˜ë“œì›¨ì–´: ë¡œë“œì…€, ìŠ¤í”¼ì»¤, LED ì œì–´ ì™„ë²½ í†µí•©
 * 4. ì›¹ ì„œë²„: í™”ë ¤í•œ GUI ë””ìì¸ ì½”ë“œ ë³µêµ¬ (HTML/CSS ìƒì„¸ ê¸°ìˆ )
 */

#include <WiFi.h>
#include <WiFiClientSecure.h> // [í•„ìˆ˜] HTTPS ë³´ì•ˆ í†µì‹ 
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include "HX711.h"
#include <Preferences.h>
#include "DFRobotDFPlayerMini.h" 
#include <esp_task_wdt.h> 
#include <driver/i2s.h>   

// ============================================================
// [0] ì„¤ì • ë° í•€ ì •ì˜
// ============================================================
// ìƒ‰ìƒ ì½”ë“œ (ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„°ìš©)
#define C_RESET   "\033[0m"
#define C_RED     "\033[31m"
#define C_GREEN   "\033[32m"
#define C_YELLOW  "\033[33m"
#define C_BLUE    "\033[34m"
#define C_MAGENTA "\033[35m"
#define C_CYAN    "\033[36m"
#define C_BOLD    "\033[1m"

// ì™“ì¹˜ë… íƒ€ì´ë¨¸ (ë„¤íŠ¸ì›Œí¬ ì§€ì—° ê³ ë ¤ 30ì´ˆ)
#define WDT_TIMEOUT 30 

// â˜… ì™€ì´íŒŒì´ & ì„œë²„ ì •ë³´ (ë³¸ì¸ ê²ƒìœ¼ë¡œ ë³€ê²½!)
const char* ssid      = "Jaehong_WiFi";         
const char* password  = "12345678";           
String serverName = "https://tgrwszo3iwurntqeq76s5rro640asnwq.lambda-url.ap-northeast-2.on.aws/";

// 1. ëª¨í„° & LED í•€ ë§µí•‘
const int PIN_SUNNY  = 26; 
const int PIN_CLOUDY = 27; 
const int PIN_RAIN   = 14; 
const int PIN_SNOW   = 13; 
const int PIN_LED    = 2;  

// 2. ë¡œë“œì…€ í•€ ë§µí•‘
const int LOADCELL_DOUT_PIN = 16; 
const int LOADCELL_SCK_PIN  = 4;    

// 3. DFPlayer (ìŠ¤í”¼ì»¤) í•€ ë§µí•‘
const int DFPLAYER_RX_PIN = 32; 
const int DFPLAYER_TX_PIN = 33; 

// 4. ë§ˆì´í¬(INMP441) I2S í•€ ë§µí•‘
#define I2S_WS  19  
#define I2S_SD  21  
#define I2S_SCK 18  
#define I2S_PORT I2S_NUM_0

// ì˜¤ë””ì˜¤ ì„¤ì •
#define SAMPLE_RATE 16000    
#define BIT_PER_SAMPLE 16    
#define RECORD_TIME 2        

// ì „ì—­ ê°ì²´ ì„ ì–¸
HardwareSerial mySoftwareSerial(2); 
DFRobotDFPlayerMini myDFPlayer;
HX711 scale;
Preferences prefs;
WiFiServer webServer(80); 

// ì‹œìŠ¤í…œ ìƒíƒœ ë³€ìˆ˜
unsigned long sprayDuration = 3000; 
const long REST_TIME      = 5000;    
const long MAX_RUN_TIME   = 270000; 
float calibration_factor = 430.0; 
int currentVolume = 20;    
int currentMode = 0;        
bool isRunning = false;    
int activePin = -1;        
bool isSpraying = false;    
String lastWebMessage = "ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ (Ready)";
String inputBuffer = "";  

// â˜… [í•µì‹¬] ì•± ì—°ë™ì„ ìœ„í•œ í´ë§ íƒ€ì´ë¨¸
unsigned long lastPollTime = 0;
const unsigned long POLL_INTERVAL = 2000; // 2ì´ˆë§ˆë‹¤ ì„œë²„ í™•ì¸

// ê¸°íƒ€ íƒ€ì´ë¨¸ ë° ë³€ìˆ˜
int demoStep = 0;
unsigned long prevDemoMillis = 0;
unsigned long prevMotorMillis = 0; 
unsigned long lastCheckTime = 0; 
unsigned long prevLedMillis = 0;
unsigned long startTimeMillis = 0; 
int ledBrightness = 0;
int ledFadeAmount = 5;
unsigned long lastWeatherCallMillis = 0;
const unsigned long WEATHER_INTERVAL = 3600000; 
String lastWeatherRegion = "ì„œìš¸";              

// WAV í—¤ë” êµ¬ì¡°ì²´
struct WavHeader {
  char riff[4]; uint32_t overall_size; char wave[4];
  char fmt_chunk_marker[4]; uint32_t length_of_fmt; uint16_t format_type; uint16_t channels;
  uint32_t sample_rate; uint32_t byterate; uint16_t block_align; uint16_t bits_per_sample;
  char data_chunk_header[4]; uint32_t data_size;
};

// í•¨ìˆ˜ ì„ ì–¸ë¶€
void initMicrophone(); 
int32_t readMicrophoneNoise(); 
void recordAndSendVoice(); 
void pollServer(); // â˜… ì•± ì—°ë™ í•¨ìˆ˜
void sendServerRequest(String payload);
void connectWiFi();
void manageWiFi();
void forceAllOff();
void stopSystem();
void playSound(int trackNum);
void changeVolume(int vol);
void printMainMenu();
void handleWebClient();
void checkSerialInput();
void handleInput(String input);
void runSprayLogic();
void checkSafety();
void runAutoDemoLoop();
void systemHeartbeat();
void bootAnimation();
void printDashboard();
void printCalibrationInfo();
void redrawInputLine(String &buffer);
void runManualMode(String input);
void autoWeatherScheduler();

// ============================================================
// [1] ì´ˆê¸°í™” (Setup)
// ============================================================
void setup() {
  Serial.begin(115200);
  Serial.setTimeout(5000); 
  
  // ì™“ì¹˜ë… ì„¤ì • (ì‹œìŠ¤í…œ ë‹¤ìš´ ë°©ì§€)
  esp_task_wdt_config_t wdt_config = {
      .timeout_ms = WDT_TIMEOUT * 1000,
      .idle_core_mask = (1 << 0) | (1 << 1),
      .trigger_panic = true
  };
  esp_task_wdt_init(&wdt_config);
  esp_task_wdt_add(NULL);

  // í•€ ëª¨ë“œ ì„¤ì •
  pinMode(PIN_SUNNY, OUTPUT);
  pinMode(PIN_CLOUDY, OUTPUT);
  pinMode(PIN_RAIN, OUTPUT);
  pinMode(PIN_SNOW, OUTPUT);
  pinMode(PIN_LED, OUTPUT); 
  forceAllOff(); 

  Serial.print("\r\n\r\n");
  Serial.printf(C_BOLD " ğŸš€ SMART DIFFUSER V10.1 (Expanded Version) \r\n" C_RESET);

  // 1. ìŠ¤í”¼ì»¤ ì´ˆê¸°í™”
  mySoftwareSerial.begin(9600, SERIAL_8N1, DFPLAYER_RX_PIN, DFPLAYER_TX_PIN);
  Serial.print(C_YELLOW "[System] Audio Module Init..." C_RESET);
  if (!myDFPlayer.begin(mySoftwareSerial)) {
    Serial.println(C_RED "FAILED! (Check Connection)" C_RESET);
  } else {
    Serial.println(C_GREEN " DONE!" C_RESET);
  }

  // 2. ë§ˆì´í¬ ì´ˆê¸°í™”
  Serial.print(C_YELLOW "[System] Microphone Init..." C_RESET);
  initMicrophone();
  Serial.println(C_GREEN " DONE! (16kHz)" C_RESET);

  // 3. ì„¤ì •ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
  prefs.begin("diffuser", false); 
  float savedFactor = prefs.getFloat("cal_factor", 0.0);
  if (savedFactor != 0.0) calibration_factor = savedFactor;
  currentVolume = prefs.getInt("volume", 20); 
  myDFPlayer.volume(currentVolume);

  // 4. WiFi ì—°ê²°
  connectWiFi();
  webServer.begin(); 
  
  // 5. ë¡œë“œì…€ ì´ˆê¸°í™”
  scale.begin(LOADCELL_DOUT_PIN, LOADCELL_SCK_PIN);
  scale.set_scale(calibration_factor);
  scale.tare(); 
  
  bootAnimation();
  printMainMenu(); 
}

// ============================================================
// [2] ë©”ì¸ ë£¨í”„ (Loop)
// ============================================================
void loop() {
  esp_task_wdt_reset(); // ì™“ì¹˜ë… ë¦¬ì…‹

  manageWiFi();       
  systemHeartbeat(); 
  handleWebClient(); 
  autoWeatherScheduler();
  
  // â˜… [ì¤‘ìš”] ì•± ëª…ë ¹ í™•ì¸ (í´ë§)
  pollServer(); 
  
  if (currentMode == 5) {
      runAutoDemoLoop(); 
  } else if (isRunning) {
      runSprayLogic();    
      checkSafety();      
  }
  
  checkSerialInput(); 
}

// ============================================================
// [3] â˜… í†µì‹  ë° ì•± ì—°ë™ í•¨ìˆ˜ (í•µì‹¬)
// ============================================================

// [ì•± ì—°ë™] ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ì— ëª…ë ¹ í™•ì¸
void pollServer() {
    if (isRunning || currentMode == 5) return; // ë‹¤ë¥¸ ë™ì‘ ì¤‘ì¼ ë• ê±´ë„ˆëœ€
    
    unsigned long now = millis();
    if (now - lastPollTime >= POLL_INTERVAL) {
        lastPollTime = now;
        
        if(WiFi.status() != WL_CONNECTED) return;

        WiFiClientSecure client;
        client.setInsecure(); // â˜… HTTPS ì¸ì¦ì„œ ë¬´ì‹œ (í•„ìˆ˜)
        
        HTTPClient http;
        http.setTimeout(3000); // 3ì´ˆ íƒ€ì„ì•„ì›ƒ
        
        if (http.begin(client, serverName)) {
            http.addHeader("Content-Type", "application/json");
            // POLL ìš”ì²­ ì „ì†¡
            int code = http.POST("{\"action\": \"POLL\", \"deviceId\": \"App_User\"}");
            
            if (code > 0) {
                String res = http.getString();
                JsonDocument doc;
                deserializeJson(doc, res);
                int cmd = doc["spray"]; // ëª…ë ¹ í™•ì¸
                
                // ëª…ë ¹ì´ ìˆìœ¼ë©´ ì‹¤í–‰!
                if (cmd > 0) {
                     Serial.printf("\r\n" C_GREEN "ğŸ“² [APP] ì•± ëª…ë ¹ ìˆ˜ì‹ : %dë²ˆ ë¶„ì‚¬!\r\n" C_RESET, cmd);
                     
                     int target = -1;
                     if (cmd == 1) target = PIN_SUNNY;
                     else if (cmd == 2) target = PIN_CLOUDY;
                     else if (cmd == 3) target = PIN_RAIN;
                     else if (cmd == 4) target = PIN_SNOW;
                     
                     if (target != -1) {
                         forceAllOff();
                         activePin = target;
                         isRunning = true;
                         isSpraying = true;
                         sprayDuration = 3000;
                         prevMotorMillis = millis();
                         startTimeMillis = millis();
                         
                         digitalWrite(activePin, LOW); // ë¶„ì‚¬ ON
                         playSound(cmd); // íš¨ê³¼ìŒ ì¬ìƒ
                         
                         lastWebMessage = "ì•± ì œì–´ ì‹¤í–‰ ì¤‘...";
                         
                         // ì¸í„°í˜ì´ìŠ¤ ë³µêµ¬
                         Serial.print(C_YELLOW "ğŸ‘‰ ëª…ë ¹ ì…ë ¥ >>" C_RESET);
                         Serial.print(inputBuffer);
                     }
                }
            }
            http.end();
        }
    }
}

// [ìŒì„± ì¸ì‹] ë…¹ìŒ ë° ì „ì†¡
void recordAndSendVoice() {
    if(WiFi.status() != WL_CONNECTED) {
        Serial.println(C_RED "WiFi Disconnected" C_RESET);
        return;
    }

    uint32_t dataSize = SAMPLE_RATE * RECORD_TIME * 2;
    uint32_t totalSize = sizeof(WavHeader) + dataSize;
    
    Serial.printf(C_YELLOW "\r\n[Voice] ğŸ¤ ë…¹ìŒ ì‹œì‘! (2ì´ˆ)...\r\n" C_RESET);
    
    uint8_t* audioBuffer = (uint8_t*)malloc(totalSize);
    if (audioBuffer == NULL) {
        Serial.println(C_RED "Memory Allocation Failed" C_RESET);
        return;
    }

    // WAV í—¤ë” ìƒì„±
    WavHeader header;
    memcpy(header.riff, "RIFF", 4);
    header.overall_size = totalSize - 8;
    memcpy(header.wave, "WAVE", 4);
    memcpy(header.fmt_chunk_marker, "fmt ", 4);
    header.length_of_fmt = 16;
    header.format_type = 1; // PCM
    header.channels = 1;    // Mono
    header.sample_rate = SAMPLE_RATE;
    header.byterate = SAMPLE_RATE * 2;
    header.block_align = 2;
    header.bits_per_sample = 16;
    memcpy(header.data_chunk_header, "data", 4);
    header.data_size = dataSize;
    
    memcpy(audioBuffer, &header, sizeof(WavHeader));

    // ì˜¤ë””ì˜¤ ë°ì´í„° ì½ê¸°
    size_t bytesRead = 0;
    i2s_read(I2S_PORT, (void*)(audioBuffer + sizeof(WavHeader)), dataSize, &bytesRead, portMAX_DELAY);
    
    Serial.println(C_GREEN "[Voice] ğŸ“¡ ì„œë²„ ì „ì†¡ ì¤‘..." C_RESET);

    WiFiClientSecure client;
    client.setInsecure(); // â˜… ë³´ì•ˆ ì„¤ì •
    
    HTTPClient http;
    http.setTimeout(15000); // 15ì´ˆ íƒ€ì„ì•„ì›ƒ

    if (http.begin(client, serverName)) {
        http.addHeader("Content-Type", "audio/wav");
        int httpCode = http.POST(audioBuffer, totalSize);
        
        if (httpCode > 0) {
            String res = http.getString();
            Serial.printf(C_GREEN "âœ… ì‘ë‹µ: %s\r\n" C_RESET, res.c_str());
            
            JsonDocument doc;
            deserializeJson(doc, res);
            int cmd = doc["spray"];
            int dur = doc["duration"];
            String txt = doc["result_text"];

            if (cmd > 0) {
                forceAllOff();
                activePin = (cmd==1)?PIN_SUNNY : (cmd==2)?PIN_CLOUDY : (cmd==3)?PIN_RAIN : PIN_SNOW;
                
                isRunning = true;
                isSpraying = true;
                sprayDuration = dur * 1000;
                prevMotorMillis = millis();
                startTimeMillis = millis();
                
                digitalWrite(activePin, LOW);
                playSound(cmd);
                
                lastWebMessage = "ìŒì„± ì„±ê³µ: " + txt;
                Serial.printf("ğŸ‘‰ ì‹¤í–‰: %s (%dì´ˆ)\r\n", txt.c_str(), dur);
            } else { 
                Serial.printf("âš ï¸ ëŒ€ê¸°: %s\r\n", txt.c_str()); 
            }
        } else {
            Serial.printf(C_RED "HTTP Error: %s\r\n" C_RESET, http.errorToString(httpCode).c_str());
        }
        http.end();
    }
    free(audioBuffer);
    Serial.print(C_YELLOW "ğŸ‘‰ ëª…ë ¹ ì…ë ¥ >>" C_RESET);
}

// [ì¼ë°˜ ìš”ì²­] ë‚ ì”¨ ì •ë³´ ì¡°íšŒ ë“±
void sendServerRequest(String payload) {
  if(WiFi.status() != WL_CONNECTED) {
      Serial.println(C_RED "WiFi Disconnected" C_RESET);
      return; 
  }
  
  WiFiClientSecure client;
  client.setInsecure(); // â˜… ë³´ì•ˆ ì„¤ì •
  
  HTTPClient http; 
  http.setTimeout(10000); 
  
  if (!http.begin(client, serverName)) return;
  
  http.addHeader("Content-Type", "application/json");
  int code = http.POST(payload);
  
  if(code > 0){
    String res = http.getString();
    JsonDocument doc;
    deserializeJson(doc, res);
    
    int cmd = doc["spray"];
    int dur = doc["duration"];
    String txt = doc["result_text"];
    
    Serial.printf("\r\nâœ… ì„œë²„ ì‘ë‹µ: %s\r\n", txt.c_str());
    
    int target = -1;
    if (cmd == 1) target = PIN_SUNNY;
    else if (cmd == 2) target = PIN_CLOUDY;
    else if (cmd == 3) target = PIN_RAIN;
    else if (cmd == 4) target = PIN_SNOW;
    
    if (target != -1) { 
        forceAllOff();
        activePin = target;
        isRunning = true;
        isSpraying = true;
        sprayDuration = dur * 1000;
        prevMotorMillis = millis();
        startTimeMillis = millis();
        
        digitalWrite(activePin, LOW);
        playSound(cmd);
        
        lastWebMessage = txt;
    }
  } 
  http.end();
  Serial.print(C_YELLOW "ğŸ‘‰ ëª…ë ¹ ì…ë ¥ >>" C_RESET);
  Serial.print(inputBuffer);
}

// ============================================================
// [4] ì›¹ ì„œë²„ (HTML ë””ìì¸ ë³µêµ¬)
// ============================================================
void handleWebClient() {
  WiFiClient client = webServer.available();
  if (!client) return;
  
  unsigned long startTime = millis();
  while (!client.available() && millis() - startTime < 1000) { delay(1); }
  
  String request = "";
  while (client.connected() && client.available()) {
      char c = client.read();
      request += c;
  }

  // ê°„ë‹¨ ëª…ë ¹ ì²˜ë¦¬
  if (request.indexOf("GET /RUN_") >= 0 || request.indexOf("GET /STOP") >= 0 || request.indexOf("GET /VOL_") >= 0) {
      if (request.indexOf("GET /RUN_SUNNY") >= 0) { runManualMode("1"); lastWebMessage = "ìˆ˜ë™: ë§‘ìŒ"; }
      if (request.indexOf("GET /RUN_CLOUDY") >= 0) { runManualMode("2"); lastWebMessage = "ìˆ˜ë™: íë¦¼"; }
      if (request.indexOf("GET /RUN_RAIN") >= 0) { runManualMode("3"); lastWebMessage = "ìˆ˜ë™: ë¹„"; }
      if (request.indexOf("GET /RUN_SNOW") >= 0) { runManualMode("4"); lastWebMessage = "ìˆ˜ë™: ëˆˆ"; }
      if (request.indexOf("GET /STOP") >= 0) { stopSystem(); lastWebMessage = "ì •ì§€ë¨"; }
      if (request.indexOf("GET /VOL_UP") >= 0) { changeVolume(currentVolume + 2); }
      if (request.indexOf("GET /VOL_DOWN") >= 0) { changeVolume(currentVolume - 2); }
      
      client.println("HTTP/1.1 204 No Content\r\nConnection: close\r\n");
  } 
  else {
      // ë©”ì¸ í˜ì´ì§€ ì¶œë ¥ (ìƒì„¸í•œ HTML)
      client.println("HTTP/1.1 200 OK\r\nContent-type:text/html\r\nConnection: close\r\n");
      client.println("<!DOCTYPE html><html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1'>");
      
      // CSS ìŠ¤íƒ€ì¼
      client.println("<style>");
      client.println("body{font-family:sans-serif;text-align:center;background:#1a1a1a;color:white;padding:10px;}");
      client.println(".btn{display:block;width:100%;max-width:400px;margin:10px auto;padding:15px;font-size:18px;border-radius:10px;border:none;color:white;cursor:pointer;}");
      client.println(".vol{display:inline-block;width:48%;margin:5px 1%;padding:15px;}");
      client.println(".status{background:#333;color:#0f0;padding:15px;border-radius:10px;border:1px solid #555;max-width:400px;margin:10px auto;}");
      client.println(".sunny{background:#f1c40f;color:#000}.cloudy{background:#95a5a6}.rain{background:#3498db}.snow{background:#ecf0f1;color:#000}");
      client.println(".red{background:#e74c3c}.blue{background:#3498db}.grey{background:#7f8c8d}");
      client.println("</style>");
      
      // JS ìŠ¤í¬ë¦½íŠ¸
      client.println("<script>function send(u){fetch(u);setTimeout(()=>{location.reload()},500)}</script>");
      client.println("</head><body>");
      
      // Body ë‚´ìš©
      client.printf("<h1>Smart Diffuser V10.1</h1>");
      client.printf("<div class='status'>ğŸ“¢ ìƒíƒœ: %s</div>", lastWebMessage.c_str());
      
      client.printf("<div style='background:#222;padding:10px;border-radius:10px;margin:10px auto;max-width:400px;'>");
      client.printf("<p>ğŸ¤ ì†Œë¦¬(Noise): %d</p>", readMicrophoneNoise());
      client.printf("<p>âš–ï¸ ë¬´ê²Œ(CH4): %.2fg</p>", scale.get_units(5));
      client.printf("<p>ğŸ“¡ WiFi: %ddBm</p></div>", WiFi.RSSI());

      client.println("<button class='btn sunny' onclick=\"send('/RUN_SUNNY')\">â˜€ï¸ ë§‘ìŒ (Sunny)</button>");
      client.println("<button class='btn cloudy' onclick=\"send('/RUN_CLOUDY')\">â˜ï¸ íë¦¼ (Cloudy)</button>");
      client.println("<button class='btn rain' onclick=\"send('/RUN_RAIN')\">â˜” ë¹„ (Rain)</button>");
      client.println("<button class='btn snow' onclick=\"send('/RUN_SNOW')\">â„ï¸ ëˆˆ (Snow)</button>");
      
      client.printf("<div style='max-width:400px;margin:0 auto;'><button class='btn vol grey' onclick=\"send('/VOL_DOWN')\">ğŸ”‰ Vol -</button>");
      client.printf("<button class='btn vol blue' onclick=\"send('/VOL_UP')\">ğŸ”Š Vol + (%d)</button></div>", currentVolume);
      
      client.println("<button class='btn red' onclick=\"send('/STOP')\">â›” EMERGENCY STOP</button>");
      client.println("</body></html>");
  }
  delay(10); client.stop();
}

// ============================================================
// [5] í•˜ë“œì›¨ì–´ & ê¸°ë³¸ í•¨ìˆ˜
// ============================================================

void initMicrophone() {
  const i2s_config_t i2s_config = {
    .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX),
    .sample_rate = SAMPLE_RATE,
    .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
    .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT,
    .communication_format = i2s_comm_format_t(I2S_COMM_FORMAT_I2S | I2S_COMM_FORMAT_I2S_MSB),
    .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1,
    .dma_buf_count = 8,
    .dma_buf_len = 64,
    .use_apll = false,
    .tx_desc_auto_clear = false,
    .fixed_mclk = 0
  };
  const i2s_pin_config_t pin_config = {
    .bck_io_num = I2S_SCK,
    .ws_io_num = I2S_WS,
    .data_out_num = I2S_PIN_NO_CHANGE,
    .data_in_num = I2S_SD
  };
  i2s_driver_install(I2S_PORT, &i2s_config, 0, NULL);
  i2s_set_pin(I2S_PORT, &pin_config);
}

int32_t readMicrophoneNoise() {
  int16_t sample = 0;
  size_t bytes_read = 0;
  i2s_read(I2S_PORT, &sample, sizeof(sample), &bytes_read, 0); 
  if (bytes_read > 0) {
      int32_t rawValue = abs(sample);
      if (rawValue < 500) return 0; // ë…¸ì´ì¦ˆ í•„í„°
      return rawValue; 
  }
  return 0;
}

void connectWiFi() {
  Serial.printf(C_YELLOW "[System] WiFi Connecting" C_RESET);
  WiFi.begin(ssid, password);
  int retry = 0;
  while(WiFi.status() != WL_CONNECTED && retry < 15) { delay(200); Serial.print("."); retry++; }
  if (WiFi.status() == WL_CONNECTED) {
    Serial.printf("\r\n" C_GREEN "Connected! (%d dBm)\r\n" C_RESET, WiFi.RSSI());
    Serial.printf(C_CYAN "ğŸŒ Web: http://%s/\r\n" C_RESET, WiFi.localIP().toString().c_str());
  } else { Serial.printf(C_RED "\r\nWiFi Failed.\r\n" C_RESET); }
}

void manageWiFi() {
  static bool wasConnected = true; 
  if (millis() - lastCheckTime >= 1000) {
    lastCheckTime = millis();
    if (WiFi.status() != WL_CONNECTED) {
      if (wasConnected) { 
        wasConnected = false;
        WiFi.disconnect(); WiFi.reconnect();
      }
    } else if (!wasConnected) wasConnected = true;
  }
}

void checkSerialInput() {
  while (Serial.available() > 0) {
    char c = Serial.read();
    if (c == '\n' || c == '\r') {
      if (inputBuffer.length() > 0) {
        Serial.println();
        if (inputBuffer == "0") { stopSystem(); currentMode = 0; printMainMenu(); }
        else { handleInput(inputBuffer); }
        inputBuffer = "";
      }
    } else if (c == '\b' || c == 0x7F) {
      if (inputBuffer.length() > 0) {
        inputBuffer.remove(inputBuffer.length() - 1);
        redrawInputLine(inputBuffer);
      }
    } else {
      inputBuffer += c;
      redrawInputLine(inputBuffer);
    }
  }
}

void redrawInputLine(String &buffer) {
  Serial.print("\r\033[K");
  Serial.print(C_YELLOW "ğŸ‘‰ ëª…ë ¹ ì…ë ¥ >>" C_RESET);
  Serial.print(buffer);
}

void handleInput(String input) {
    if(currentMode==0){
        if(input=="1"){currentMode=1;Serial.println("\r\n[Mode 1] ìˆ˜ë™ ì œì–´");}
        else if(input=="2"){currentMode=2;Serial.println("\r\n[Mode 2] ê°ì„± ëª¨ë“œ");}
        else if(input=="3"){currentMode=3;Serial.println("\r\n[Mode 3] ë‚ ì”¨ ëª¨ë“œ");}
        else if(input=="4"){currentMode=4;Serial.println("\r\n[Mode 4] ì„¤ì • ëª¨ë“œ");}
        else if(input=="5"){currentMode=5;Serial.println("\r\n[Mode 5] ë°ëª¨ ëª¨ë“œ"); demoStep=0;}
        else if(input=="6"){currentMode=6;Serial.println("\r\n[Mode 6] ğŸ¤ ìŒì„± ë…¹ìŒ ì‹œì‘..."); recordAndSendVoice(); currentMode=0; printMainMenu();}
        else if(input=="9"){printDashboard();}
        printMainMenu();
    } else if(currentMode==1) {
        if(input=="+") changeVolume(currentVolume+2);
        else if(input=="-") changeVolume(currentVolume-2);
        else runManualMode(input);
    } else if(currentMode==2) {
        Serial.println("[Emotion] ìš”ì²­...");
        sendServerRequest("{\"mode\": \"emotion\", \"user_emotion\": \"" + input + "\"}");
    } else if(currentMode==3) {
        lastWeatherRegion = input;
        float w = scale.get_units(10);
        Serial.printf("[Weather] %s ì¡°íšŒ ì¤‘...\r\n", input.c_str());
        sendServerRequest("{\"mode\": \"weather\", \"region\": \"" + input + "\", \"w4\": " + String(w) + "}");
    } else if(currentMode==4) {
        if(input=="+") { calibration_factor+=10; scale.set_scale(calibration_factor); printCalibrationInfo(); }
        else if(input=="-") { calibration_factor-=10; scale.set_scale(calibration_factor); printCalibrationInfo(); }
        else if(input=="t") { scale.tare(); Serial.println("Tare Completed"); }
        else if(input=="s") { prefs.putFloat("cal_factor", calibration_factor); Serial.println("Saved"); }
        else if(input=="0") { currentMode=0; printMainMenu(); }
    }
}

void runManualMode(String input) {
    int target = -1;
    if(input=="1") target=PIN_SUNNY;
    else if(input=="2") target=PIN_CLOUDY;
    else if(input=="3") target=PIN_RAIN;
    else if(input=="4") target=PIN_SNOW;
    
    if(target != -1) {
        forceAllOff();
        activePin = target;
        isRunning = true;
        isSpraying = true;
        sprayDuration = 3000;
        prevMotorMillis = millis();
        startTimeMillis = millis();
        
        digitalWrite(activePin, LOW);
        playSound(input.toInt());
        
        Serial.printf("\r\n[Manual] %së²ˆ ë¶„ì‚¬ ì‹œì‘\r\n", input.c_str());
        Serial.print(C_YELLOW "ğŸ‘‰ ëª…ë ¹ ì…ë ¥ >>" C_RESET);
    } else if(input=="0") {
        currentMode=0;
        stopSystem();
        printMainMenu();
    }
}

void runSprayLogic() {
  if (activePin == -1) return;
  
  if (isSpraying) {
    if (millis() - prevMotorMillis >= sprayDuration) {
      digitalWrite(activePin, HIGH); // OFF
      isSpraying = false;
      prevMotorMillis = millis();
      
      if(currentMode == 1) {
          stopSystem();
          Serial.println("\r\n[ì™„ë£Œ] ë™ì‘ ì¢…ë£Œ");
          printMainMenu();
      } else {
          Serial.println("\r\n[íœ´ì‹] ëŒ€ê¸° ì¤‘...");
          Serial.print(C_YELLOW "ğŸ‘‰ ëª…ë ¹ ì…ë ¥ >>" C_RESET);
          Serial.print(inputBuffer);
      }
    }
  } else {
    if (millis() - prevMotorMillis >= REST_TIME) {
      forceAllOff();
      digitalWrite(activePin, LOW); // ON
      isSpraying = true;
      prevMotorMillis = millis();
      Serial.println("\r\n[ì¬ë¶„ì‚¬] ì‹œì‘!");
      Serial.print(C_YELLOW "ğŸ‘‰ ëª…ë ¹ ì…ë ¥ >>" C_RESET);
      Serial.print(inputBuffer);
    }
  }
}

void runAutoDemoLoop() {
  if (millis() - prevDemoMillis >= 4000) {
    prevDemoMillis = millis();
    forceAllOff();
    demoStep++;
    if (demoStep > 4) demoStep = 1;
    
    int t = -1;
    if (demoStep == 1) t = PIN_SUNNY;
    else if (demoStep == 2) t = PIN_CLOUDY;
    else if (demoStep == 3) t = PIN_RAIN;
    else if (demoStep == 4) t = PIN_SNOW;
    
    digitalWrite(t, LOW);
    playSound(demoStep);
    Serial.printf("\r\n[Demo] Step %d ì‹¤í–‰\r\n", demoStep);
  }
}

void checkSafety() {
  if (millis() - startTimeMillis > MAX_RUN_TIME) {
      stopSystem();
      Serial.println(C_RED "\r\nğŸš¨ ì•ˆì „ ì°¨ë‹¨ ì‘ë™ (ì‹œê°„ ì´ˆê³¼)" C_RESET);
  }
}

void printCalibrationInfo() {
    Serial.printf("Factor: %.1f, Weight: %.2f g\r\n", calibration_factor, scale.get_units(5));
}

void systemHeartbeat() {
    if(!isRunning && millis()-prevLedMillis >= 30) {
        prevLedMillis = millis();
        ledBrightness += ledFadeAmount;
        if(ledBrightness <= 0 || ledBrightness >= 255) ledFadeAmount = -ledFadeAmount;
        analogWrite(PIN_LED, ledBrightness);
    }
}

void bootAnimation() {
    for(int i=0; i<3; i++) {
        digitalWrite(PIN_LED, HIGH); delay(100);
        digitalWrite(PIN_LED, LOW); delay(100);
    }
}

void printDashboard() {
    Serial.println("\r\n=========================");
    Serial.println("   ğŸ“Š SYSTEM DASHBOARD   ");
    Serial.println("=========================");
    Serial.printf(" WiFi Signal : %d dBm\r\n", WiFi.RSSI());
    Serial.printf(" Weight(CH4) : %.2f g\r\n", scale.get_units(10));
    Serial.printf(" Mic Noise   : %d\r\n", readMicrophoneNoise());
    Serial.printf(" Volume      : %d\r\n", currentVolume);
    printMainMenu();
}

void playSound(int trackNum) {
  myDFPlayer.play(trackNum);
}

void forceAllOff() {
  digitalWrite(PIN_SUNNY, HIGH);
  digitalWrite(PIN_CLOUDY, HIGH);
  digitalWrite(PIN_RAIN, HIGH);
  digitalWrite(PIN_SNOW, HIGH);
}

void stopSystem() {
  forceAllOff();
  isRunning = false;
  activePin = -1;
  isSpraying = false;
  myDFPlayer.stop();
}

void changeVolume(int vol) {
    currentVolume = constrain(vol, 0, 30);
    myDFPlayer.volume(currentVolume);
    prefs.putInt("volume", currentVolume);
    Serial.printf("Vol: %d\r\n", currentVolume);
}

void autoWeatherScheduler() {
  if (currentMode != 3 || isRunning) return;
  if (millis() - lastWeatherCallMillis >= WEATHER_INTERVAL) {
    lastWeatherCallMillis = millis();
    float w = scale.get_units(10);
    Serial.printf("\r\n[AUTO] ë‚ ì”¨ ê°±ì‹  ì¤‘...\r\n");
    sendServerRequest("{\"mode\": \"weather\", \"region\": \"" + lastWeatherRegion + "\", \"w4\": " + String(w) + "}");
  }
}

void printMainMenu() {
  Serial.printf(C_CYAN "\r\n=== ğŸ•¹ï¸ MAIN MENU (V10.1) ğŸ•¹ï¸ ===\r\n" C_RESET);
  Serial.println(" [1] ìˆ˜ë™ ì œì–´");
  Serial.println(" [2] ê°ì„± ëª¨ë“œ");
  Serial.println(" [3] ë‚ ì”¨ ëª¨ë“œ");
  Serial.println(" [4] ì •ë°€ ì„¤ì •");
  Serial.println(" [5] ì˜¤í†  ë°ëª¨");
  Serial.println(" [6] ğŸ¤ ìŒì„± ì¸ì‹");
  Serial.println(" [9] ëŒ€ì‹œë³´ë“œ");
  Serial.print(C_YELLOW "ğŸ‘‰ ëª…ë ¹ ì…ë ¥ >>" C_RESET);
}
